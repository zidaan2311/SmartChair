<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Chair Monitoring</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .status-dot { height: 12px; width: 12px; border-radius: 50%; display: inline-block; }
        .bg-sitting { background-color: #10b981; box-shadow: 0 0 15px rgba(16, 185, 129, 0.4); }
        .bg-empty { background-color: #ef4444; box-shadow: 0 0 15px rgba(239, 68, 68, 0.4); }
        .card-glass { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px); }
    </style>
</head>
<body class="bg-slate-50 min-h-screen text-slate-800">

    <nav class="bg-indigo-600 text-white p-4 shadow-lg">
        <div class="container mx-auto flex justify-between items-center">
            <div class="flex items-center space-x-2">
                <i data-lucide="armchair" class="w-8 h-8"></i>
                <h1 class="text-xl font-bold tracking-tight">Smart Chair Monitoring</h1>
            </div>
            <div id="connection-status" class="flex items-center space-x-2 text-sm bg-indigo-700 px-3 py-1 rounded-full">
                <span class="status-dot bg-yellow-400" id="db-dot"></span>
                <span id="db-text">Menghubungkan...</span>
            </div>
        </div>
    </nav>

    <main class="container mx-auto p-4 md:p-8">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            
            <!-- Big Status Card -->
            <div class="lg:col-span-2 card-glass rounded-3xl p-8 shadow-sm border border-slate-200 flex flex-col items-center justify-center text-center">
                <h2 class="text-slate-500 font-semibold uppercase tracking-wider text-sm mb-4">Status Penggunaan</h2>
                <div id="status-icon-container" class="w-32 h-32 rounded-full flex items-center justify-center mb-6 transition-all duration-500">
                    <i data-lucide="user" id="main-status-icon" class="w-16 h-16 text-white"></i>
                </div>
                <div id="status-text" class="text-4xl font-extrabold mb-2">---</div>
                <div id="status-subtext" class="text-slate-500">Mendeteksi data...</div>
            </div>

            <!-- Duration Card -->
            <div class="card-glass rounded-3xl p-8 shadow-sm border border-slate-200 flex flex-col justify-between">
                <div>
                    <h2 class="text-slate-500 font-semibold uppercase tracking-wider text-sm mb-2">Durasi Duduk</h2>
                    <i data-lucide="timer" class="w-8 h-8 text-indigo-500 mb-4"></i>
                </div>
                <div>
                    <div id="duration-display" class="text-5xl font-mono font-bold text-slate-900">00:00:00</div>
                    <p class="text-slate-400 text-sm mt-2">Waktu akumulasi sesi saat ini</p>
                </div>
            </div>

            <!-- Sensor Distance Grid -->
            <div class="card-glass rounded-3xl p-6 shadow-sm border border-slate-200">
                <div class="flex items-center space-x-3 mb-6">
                    <div class="p-2 bg-blue-100 rounded-lg text-blue-600">
                        <i data-lucide="ruler"></i>
                    </div>
                    <h3 class="font-bold">Sensor Jarak (Ultrasonik)</h3>
                </div>
                <div class="space-y-6">
                    <div>
                        <div class="flex justify-between mb-2">
                            <span class="text-sm font-medium">Punggung Atas</span>
                            <span class="text-sm font-bold text-indigo-600" id="dist-atas">0 cm</span>
                        </div>
                        <div class="w-full bg-slate-200 rounded-full h-2">
                            <div id="bar-atas" class="bg-indigo-500 h-2 rounded-full transition-all duration-500" style="width: 0%"></div>
                        </div>
                    </div>
                    <div>
                        <div class="flex justify-between mb-2">
                            <span class="text-sm font-medium">Punggung Bawah</span>
                            <span class="text-sm font-bold text-indigo-600" id="dist-bawah">0 cm</span>
                        </div>
                        <div class="w-full bg-slate-200 rounded-full h-2">
                            <div id="bar-bawah" class="bg-indigo-500 h-2 rounded-full transition-all duration-500" style="width: 0%"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Modified Limit Switch Section (OR Logic) -->
            <div class="card-glass rounded-3xl p-6 shadow-sm border border-slate-200">
                <div class="flex items-center space-x-3 mb-6">
                    <div class="p-2 bg-orange-100 rounded-lg text-orange-600">
                        <i data-lucide="toggle-right"></i>
                    </div>
                    <h3 class="font-bold">Status Beban (Limit Switch)</h3>
                </div>
                <div class="flex flex-col items-center justify-center p-6 rounded-2xl transition-all duration-300 border h-32" id="card-limit-combined">
                    <p class="text-xs text-slate-500 uppercase tracking-widest mb-2">Sensor Tekanan</p>
                    <div id="val-limit-combined" class="text-2xl font-black">MEMUAT...</div>
                    <p id="sub-limit-combined" class="text-[10px] mt-2 text-slate-400"></p>
                </div>
            </div>

            <!-- Activity Info -->
            <div class="card-glass rounded-3xl p-6 shadow-sm border border-slate-200 flex items-center space-x-4">
                <div class="p-4 bg-green-100 rounded-2xl text-green-600">
                    <i data-lucide="activity" class="w-8 h-8"></i>
                </div>
                <div>
                    <h3 class="font-bold">Update Terakhir</h3>
                    <p id="last-update" class="text-sm text-slate-500">Menunggu data...</p>
                </div>
            </div>

        </div>

        <footer class="mt-12 text-center text-slate-400 text-xs">
            &copy; 2024 Smart Chair Project &bull; Powered by Firebase Realtime Database
        </footer>
    </main>

    <script>
        const firebaseConfig = {
            databaseURL: "https://smartchairzg-default-rtdb.asia-southeast1.firebasedatabase.app/"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        const dbText = document.getElementById('db-text');
        const dbDot = document.getElementById('db-dot');
        const statusText = document.getElementById('status-text');
        const statusSubtext = document.getElementById('status-subtext');
        const statusIconContainer = document.getElementById('status-icon-container');
        const distAtasLabel = document.getElementById('dist-atas');
        const distBawahLabel = document.getElementById('dist-bawah');
        const barAtas = document.getElementById('bar-atas');
        const barBawah = document.getElementById('bar-bawah');
        
        // Element baru untuk logika OR
        const limitCombinedVal = document.getElementById('val-limit-combined');
        const cardCombined = document.getElementById('card-limit-combined');
        const subLimitText = document.getElementById('sub-limit-combined');

        const durationDisplay = document.getElementById('duration-display');
        const lastUpdateLabel = document.getElementById('last-update');

        function formatTime(seconds) {
            const h = Math.floor(seconds / 3600);
            const m = Math.floor((seconds % 3600) / 60);
            const s = seconds % 60;
            return [h, m, s].map(v => v < 10 ? "0" + v : v).join(":");
        }

        db.ref('/monitoring_duduk').on('value', (snapshot) => {
            const data = snapshot.val();
            if (data) {
                dbText.innerText = "Terhubung";
                dbDot.className = "status-dot bg-green-400";

                const isSitting = data.status.is_sitting;
                if (isSitting) {
                    statusText.innerText = "SEDANG DIDUDUKI";
                    statusText.className = "text-4xl font-extrabold mb-2 text-emerald-600";
                    statusSubtext.innerText = "Seseorang terdeteksi duduk di kursi";
                    statusIconContainer.className = "w-32 h-32 rounded-full flex items-center justify-center mb-6 bg-sitting animate-pulse";
                } else {
                    statusText.innerText = "KURSI KOSONG";
                    statusText.className = "text-4xl font-extrabold mb-2 text-rose-500";
                    statusSubtext.innerText = "Tidak ada beban yang terdeteksi";
                    statusIconContainer.className = "w-32 h-32 rounded-full flex items-center justify-center mb-6 bg-empty";
                }

                durationDisplay.innerText = formatTime(data.status.durasi_detik || 0);

                const dA = data.sensor.jarak_atas || 0;
                const dB = data.sensor.jarak_bawah || 0;
                distAtasLabel.innerText = dA.toFixed(1) + " cm";
                distBawahLabel.innerText = dB.toFixed(1) + " cm";
                barAtas.style.width = Math.min(dA, 100) + "%";
                barBawah.style.width = Math.min(dB, 100) + "%";

                // --- LOGIKA OR UNTUK LIMIT SWITCH ---
                const lKiri = data.sensor.limit_kiri === 1;
                const lKanan = data.sensor.limit_kanan === 1;
                const isAnyLimitActive = lKiri || lKanan;

                if (isAnyLimitActive) {
                    limitCombinedVal.innerText = "AKTIF";
                    limitCombinedVal.className = "text-2xl font-black text-emerald-600";
                    cardCombined.className = "flex flex-col items-center justify-center p-6 rounded-2xl transition-all duration-300 border-2 border-emerald-500 bg-emerald-50 h-32 shadow-inner";
                    
                    // Detail info tambahan (opsional)
                    let detail = "";
                    if (lKiri && lKanan) detail = "Kiri & Kanan Aktif";
                    else if (lKiri) detail = "Hanya Sisi Kiri";
                    else if (lKanan) detail = "Hanya Sisi Kanan";
                    subLimitText.innerText = detail;
                } else {
                    limitCombinedVal.innerText = "TIDAK AKTIF";
                    limitCombinedVal.className = "text-2xl font-black text-slate-400";
                    cardCombined.className = "flex flex-col items-center justify-center p-6 rounded-2xl transition-all duration-300 border border-slate-200 bg-slate-50 h-32";
                    subLimitText.innerText = "Tidak ada tekanan";
                }

                const now = new Date();
                lastUpdateLabel.innerText = now.toLocaleTimeString('id-ID');
            }
        }, (error) => {
            dbText.innerText = "Error Koneksi";
            dbDot.className = "status-dot bg-red-500";
        });

        lucide.createIcons();
    </script>
</body>
</html>